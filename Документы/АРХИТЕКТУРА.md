# 🏗️ АРХИТЕКТУРА: FantaProjekt

**Дата**: 13 октября 2025  
**Версия**: 1.0.0

---

## 🎯 ПРИНЦИПЫ РАЗРАБОТКИ

### 1. **Неприкосновенность оригинала**
- Оригинальная логика short-video-maker НЕ МЕНЯЕТСЯ
- Все новые функции через РАСШИРЕНИЯ
- 100% обратная совместимость

### 2. **Модульная архитектура**
- Каждая новая функция = отдельный модуль
- Независимые компоненты
- Легко добавлять/удалять функции

### 3. **Масштабируемость**
- Легко добавлять новые источники контента
- Легко добавлять новые эффекты
- Легко расширять форматы

---

## 📦 СТРУКТУРА ПРОЕКТА

```
FantaProjekt/
├── src/
│   ├── core/                    # Оригинальная логика (НЕ ТРОГАТЬ!)
│   │   ├── ShortCreator.ts     # Главный класс
│   │   ├── Pexels.ts           # Pexels API
│   │   ├── Kokoro.ts           # TTS озвучка
│   │   ├── Whisper.ts          # Субтитры
│   │   └── Remotion.ts         # Рендеринг
│   │
│   ├── extensions/              # НОВЫЕ функции (добавляем здесь)
│   │   ├── sources/            # Источники контента
│   │   │   ├── SourceFactory.ts
│   │   │   ├── URLSource.ts
│   │   │   ├── FileSource.ts
│   │   │   └── PexelsSource.ts (адаптер)
│   │   │
│   │   ├── effects/            # Система эффектов
│   │   │   ├── EffectManager.ts
│   │   │   ├── OverlayEffect.ts
│   │   │   └── BlendModes.ts
│   │   │
│   │   ├── overlays/           # Текстовые оверлеи
│   │   │   ├── TextOverlay.ts
│   │   │   └── AnimatedText.ts
│   │   │
│   │   └── pipeline/           # Расширенный пайплайн
│   │       ├── EnhancedPipeline.ts
│   │       └── ContentProcessor.ts
│   │
│   ├── types/                   # Типы TypeScript
│   │   ├── core.ts             # Оригинальные типы
│   │   └── extensions.ts       # Новые типы
│   │
│   ├── server/                  # API серверы
│   │   ├── mcp-server.ts       # MCP протокол
│   │   └── rest-server.ts      # REST API
│   │
│   ├── components/              # Remotion компоненты
│   │   ├── PortraitVideo.tsx
│   │   ├── LandscapeVideo.tsx
│   │   └── EffectLayer.tsx     # НОВЫЙ
│   │
│   └── index.ts                 # Главный entry point
│
├── static/                      # Статические файлы
│   ├── music/                  # Фоновая музыка
│   └── effects/                # Библиотека эффектов (НОВОЕ)
│       ├── vhs-glitch.mp4
│       ├── light-leak.mp4
│       └── falling-snow.mp4
│
├── Документы/                   # Документация
│   ├── МАНИФЕСТ_ПРОЕКТА.md
│   ├── АРХИТЕКТУРА.md (этот файл)
│   ├── API_ДОКУМЕНТАЦИЯ.md
│   └── ПРИМЕРЫ.md
│
├── package.json
├── tsconfig.json
├── .env.example
└── README.md
```

---

## 🔄 ПОТОК ДАННЫХ

### Базовый поток (оригинал):
```
JSON Input
  ↓
ShortCreator.create()
  ↓
Pexels.search() → найти видео
  ↓
Kokoro.synthesize() → озвучка
  ↓
Whisper.transcribe() → субтитры
  ↓
Remotion.render() → финальное видео
  ↓
MP4 Output
```

### Расширенный поток (новый):
```
JSON Input
  ↓
ShortCreator.create()
  ↓
SourceFactory.getSource() → определить источник
  ├─ PexelsSource (если searchTerms)
  ├─ URLSource (если media.type = url)
  └─ FileSource (если media.type = file)
  ↓
ContentProcessor.process() → обработать контент
  ↓
EffectManager.apply() → применить эффекты (если есть)
  ↓
TextOverlay.render() → добавить текст (если есть)
  ↓
Kokoro.synthesize() → озвучка
  ↓
Whisper.transcribe() → субтитры
  ↓
EnhancedPipeline.render() → рендеринг с эффектами
  ↓
MP4 Output
```

---

## 🧩 КЛЮЧЕВЫЕ КОМПОНЕНТЫ

### 1. SourceFactory (Фабрика источников)
**Задача**: Определить и получить контент из любого источника

```typescript
interface ContentSource {
  type: 'pexels' | 'url' | 'file';
  fetch(): Promise<MediaContent>;
}

class SourceFactory {
  static create(input: SceneInput): ContentSource {
    if (input.searchTerms) return new PexelsSource(input);
    if (input.media?.type === 'url') return new URLSource(input);
    if (input.media?.type === 'file') return new FileSource(input);
    throw new Error('Unknown source type');
  }
}
```

### 2. EffectManager (Менеджер эффектов)
**Задача**: Применить эффекты наложения с blend modes

```typescript
interface OverlayEffect {
  source: string;        // путь к эффекту
  blendMode: BlendMode;  // режим наложения
  opacity: number;       // прозрачность
  loop?: boolean;        // зацикливать?
}

class EffectManager {
  apply(base: VideoLayer, effects: OverlayEffect[]): CompositeLayer {
    return effects.reduce((result, effect) => {
      return this.blendLayers(result, effect);
    }, base);
  }
}
```

### 3. TextOverlay (Текстовые оверлеи)
**Задача**: Добавить статичный или анимированный текст

```typescript
interface TextOverlayConfig {
  text: string;
  position: 'top' | 'bottom' | 'center';
  style: TextStyle;
  animation?: AnimationConfig;
}

class TextOverlay {
  render(config: TextOverlayConfig): RemotionComponent {
    return (
      <AbsoluteFill style={this.getPositionStyle(config.position)}>
        <Text style={config.style}>{config.text}</Text>
      </AbsoluteFill>
    );
  }
}
```

### 4. EnhancedPipeline (Расширенный пайплайн)
**Задача**: Собрать всё вместе с сохранением оригинальной логики

```typescript
class EnhancedPipeline {
  async render(input: CreateShortInput): Promise<VideoOutput> {
    // 1. Получить контент (новое или оригинал)
    const content = await this.getContent(input);
    
    // 2. Применить эффекты (если есть)
    const withEffects = await this.applyEffects(content, input.effects);
    
    // 3. Добавить текст (если есть)
    const withText = await this.addTextOverlays(withEffects, input.textOverlays);
    
    // 4. ОРИГИНАЛЬНАЯ логика: TTS + Whisper + Remotion
    return await this.originalPipeline.render(withText);
  }
}
```

---

## 🎨 СИСТЕМА BLEND MODES

### Как работает наложение эффектов:

```typescript
// Базовый слой (контент)
const baseLayer = <Video src={contentUrl} />;

// Эффект VHS
const vhsLayer = (
  <Video 
    src="/effects/vhs-glitch.mp4" 
    style={{
      mixBlendMode: 'overlay',
      opacity: 0.6
    }}
  />
);

// Эффект световых утечек
const lightLeakLayer = (
  <Video 
    src="/effects/light-leak.mp4" 
    style={{
      mixBlendMode: 'screen',
      opacity: 0.4
    }}
  />
);

// Композиция слоёв
<AbsoluteFill>
  {baseLayer}
  {vhsLayer}
  {lightLeakLayer}
</AbsoluteFill>
```

### Доступные Blend Modes:
- `normal` - обычное
- `multiply` - умножение (затемнение)
- `screen` - осветление
- `overlay` - перекрытие (контраст)
- `darken` - темнее
- `lighten` - светлее
- `color-dodge` - осветление цветов
- `color-burn` - затемнение цветов
- `hard-light` - жёсткий свет
- `soft-light` - мягкий свет
- `difference` - разница
- `exclusion` - исключение

---

## 🔌 API ИНТЕГРАЦИЯ

### REST API Endpoints:

#### POST /api/short-video
Создание нового ролика

**Request**:
```json
{
  "scenes": [...],
  "config": {...}
}
```

**Response**:
```json
{
  "videoId": "abc123",
  "status": "processing"
}
```

#### GET /api/short-video/:id/status
Проверка статуса

**Response**:
```json
{
  "status": "ready",
  "progress": 100,
  "url": "/api/short-video/abc123"
}
```

#### GET /api/short-video/:id
Скачать готовый ролик

**Response**: Binary (video/mp4)

---

## 🧪 ТЕСТИРОВАНИЕ

### Юнит-тесты:
```bash
npm test
```

### Интеграционные тесты:
```bash
npm run test:integration
```

### E2E тесты:
```bash
npm run test:e2e
```

---

## 🚀 ROADMAP РАЗРАБОТКИ

### Фаза 1: Базовая функциональность (СЕЙЧАС)
- ✅ Клонировать оригинальный проект
- ✅ Добавить SourceFactory (URL, Files)
- ✅ Добавить EffectManager (blend modes)
- ✅ Добавить TextOverlay
- ✅ Тестирование базовых функций

### Фаза 2: Расширенные возможности
- 🔄 Поддержка анимированных текстов
- 🔄 Библиотека готовых эффектов
- 🔄 Zoom эффекты для фото
- 🔄 Transitions между сценами

### Фаза 3: Оптимизация
- 🔄 Параллельный рендеринг
- 🔄 Кэширование контента
- 🔄 Оптимизация памяти
- 🔄 GPU ускорение (если доступно)

---

## 📋 CHECKLIST РАЗРАБОТЧИКА

### При добавлении новой функции:

- [ ] Создать новый модуль в `/src/extensions/`
- [ ] Определить интерфейс в `/src/types/extensions.ts`
- [ ] НЕ МЕНЯТЬ файлы в `/src/core/`
- [ ] Добавить обратную совместимость
- [ ] Написать юнит-тесты
- [ ] Обновить документацию
- [ ] Добавить пример использования

### При исправлении багов:

- [ ] Воспроизвести баг локально
- [ ] Написать failing test
- [ ] Исправить код
- [ ] Проверить, что тест проходит
- [ ] Запустить все тесты
- [ ] Обновить CHANGELOG.md

---

**FantaProjekt Development Team** © 2025

