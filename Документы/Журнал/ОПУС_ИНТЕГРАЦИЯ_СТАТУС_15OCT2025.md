# Интеграция Opus 4.1 (overlay-effects) — статус и инструкции

Дата: 15.10.2025

## Цель
Перенести и правильно встроить «Opus 4.1» (движок оверлеев) в FantaProjekt как модуль, без конфликтов с текущей архитектурой. Рендер строго через API 3123; статические эффекты через `/static/effects/...`; Remotion dev‑сервер 3001 — не используется в прод‑пути.

## Что сделано
- Создан модуль `packages/overlay-effects` (фасад + подготовка ассетов):
  - `src/index.ts` — экспорты.
  - `src/overlay-effects.ts` — фасад `OverlayEffects.render(...)` (временный, использует существующий `OverlayRemotion` под капотом; корректные таймауты/ретраи).
  - `src/prepare.ts` — `prepareAssets(...)` (через `OverlayCache`).
  - `src/types` — перенесены типы из Opus: `BlendMode`, `OverlayInput`, `SceneInput` и др.
  - `src/utils` — перенесены `hash.ts`, `paths.ts`.
  - `src/io` — перенесены `AssetFetcher.ts`, `CacheStore.ts`.
  - `src/core` — перенесены `OverlayEffect.ts`, `OverlayTrack.ts`, `OverlayEngine.ts` (+singleton).

- Интеграция в пайплайн:
  - `src/short-creator/ShortCreator.ts`: overlay‑ветка переключена на новый фасад модуля (`OverlayEffects.render`). Фолбэк на стандартный рендер сохранён.
  - `src/remotion/compositions/BlendOverlay.tsx`: источники эффектов берутся через API `http://localhost:3123/static/<staticEffectPath>`, исключён 3001 (`staticFile()` заменён для стабильности).

- Постоянная библиотека эффектов:
  - API добавлены в `src/server/routers/rest.ts`:
    - `POST /api/effects` — загрузка base64, кладёт в `static/effects` через `OverlayCache`, возвращает `{ staticEffectPath, url }`.
    - `GET /api/effects` — список эффектов.
    - `DELETE /api/effects/:id` — удаление по id (хешу).
  - `EffectManager` теперь поддерживает `file://` (копирует в temp → кэш → `staticEffectPath`).

- Рендер через API подтверждён: `POST /api/short-video` — готовые кейсы доходят до `ready`.

## Почему это работает стабильнее
- Эффекты всегда доступны по `http://localhost:3123/static/effects/...` (под контролем API).
- Исключена привязка к Remotion 3001 и путаница `/public` vs `/static`.
- Сохраняется кэш и детерминированные пути; валидируются MIME и размеры.

## Как запускать и проверять
1) Сборка: `npm run build`
2) Сервер: `node dist/index.js` (порт 3123 по умолчанию).
3) Эффекты:
   - Загрузка: `POST /api/effects` (JSON: `{ filename, data(base64), mimeType }`)
   - Список: `GET /api/effects`
4) Рендер: `POST /api/short-video` — используйте сцены с `effects[].staticEffectPath` или URL.
5) Статус: `GET /api/short-video/:id/status`

## Важные правила проекта
- Порты/окружение не менять без разрешения. Прод‑путь — только API 3123.
- Эффекты — в `static/effects`; доступ через `/static/effects/...`.
- Конфиг/отступы исходников сохранять; правки — точечно.
- Логи: фиксировать команды, выход и ошибки.

## Осталось сделать (передать след. разработчику)
1) Завершить перенос внутренней реализации Opus в пакет (минимум):
   - `io/Transcoder.ts` (если нужен перекод для несовместимых видео в H264/yuv420p).
   - Перенести/синхронизировать Remotion‑компоненты пакета (если будем использовать их версии): `BlendOverlay`, `MultiOverlayRenderer`.
2) Централизовать конфиг Remotion:
   - Единственная точка правды (`remotion.config.ts`): `publicDir = static`, `ChromiumOpenGlRenderer = egl` и т.д.
   - Проверить, что сборка/preview не подменяет publicDir.
3) Убрать дубли/мертвый код после успешных прогонов:
   - Аккуратно сверить старый `OverlayRemotion` и вызывать только пакетный фасад.
4) Тесты:
   - Прогнать `test-overlays*.json` на 1–5 оверлеев; замерить время/стабильность.
   - При необходимости оставить `concurrency=1`.

## Промпт для следующего разработчика
«Ты продолжаешь интеграцию модуля overlay‑effects (Opus 4.1) в FantaProjekt.
Твой чек‑лист:
1) Заверши перенос оставшихся частей Opus в `packages/overlay-effects`:
   - Добавь `io/Transcoder.ts` (перекод mp4 h264/yuv420p при несовместимости).
   - Проверь и при необходимости перенеси пакетные Remotion‑компоненты.
2) Централизуй конфиг Remotion (один файл, `publicDir=static`). Убедись, что dev‑сервер Remotion не ломает URL статики.
3) Оставь рендер через API 3123; пути к ассетам строго `/static/effects/...`.
4) Прогони тест‑кейсы `test-overlays*.json` (1–5 оверлеев). Зафиксируй тайминги и ресурсы.
5) После успеха — почисти дублирующий код (`OverlayRemotion`) и лишние `Config.set*`, но только после подтверждения стабильности.
Ограничения: не меняй порты/окружение без разрешения; не трогай несвязанные модули; сохраняй стиль кода; логи/дифф обязателен на каждый шаг.»

## Контакты/файлы
- Модуль: `packages/overlay-effects`
- Пайплайн: `src/short-creator/ShortCreator.ts`
- Эффекты/кэш: `src/short-creator/effects/{EffectManager,OverlayCache}.ts`
- API: `src/server/routers/rest.ts`
- Конфиг Remotion (текущий): `src/remotion/config/OverlayRemotionConfig.ts` (подлежит централизации)


