# ЗАДАЧА ДЛЯ РАЗРАБОТЧИКА — ПОЛНЫЙ КОНТЕКСТ (15 Oct 2025)

## Цель
Устранить нестабильность рендера видео с наложениями (overlay effects) в Remotion: периодические timeout при delayRender и/или ошибки загрузки длительности медиа. Система должна стабильно поддерживать ≥5 (желательно 10) одновременно активных наложений с независимыми таймингами и режимами смешивания, без переписывания существующих ядровых функций — только через новые модули/файлы.

## Текущее состояние
- Бэкенд: Node/TypeScript. Видео рендер: Remotion (React-композиции).
- Источник проблемы: при рендере наложений (видео-плашки VHS 01/02 и стрелка-указатель) Remotion иногда не успевает получить метаданные/длительность, что приводит к `delayRender timeout`. Также фиксировались 404 при попытке загрузки из HTTP вместо механизма `staticFile`.
- Мы перевели все оверлеи на стабильные пути внутри `static/effects` и используем `staticFile(staticEffectPath)`.
- В компоненте `BlendOverlay` добавлены `delayRender/continueRender` и события `onLoadedMetadata`/`onLoad`, а также управление таймингом через `Sequence`.
- Глобальный таймаут рендера увеличен до 120s.
- Проблема воспроизводится: последний запуск с 3 эффектами упал в статус `failed`.

## Что уже сделано
1) Кэш/хранилище оверлеев (hash-based) и конвертация в совместимый MP4 при необходимости:
   - `src/short-creator/effects/OverlayCache.ts` — создаёт файл в `static/effects/<hash>.<ext>`, возвращает `publicUrl` и `staticEffectPath`. Выполняет перекодирование в H.264 yuv420p `-movflags +faststart` при не-совместимых источниках.
   - Интеграция: `src/short-creator/effects/EffectManager.ts` — использует OverlayCache и отдаёт `staticEffectPath` для фронта Remotion.
2) Рендер-слой Remotion и фиксация источника:
   - `src/remotion/compositions/BlendOverlay.tsx` — теперь использует только `staticFile(staticEffectPath)` (если его нет — компонент не рендерится). Добавлены:
     - `delayRender/continueRender` + таймаут-фолбэк на 20s
     - обработчики `onLoadedMetadata`/`onLoad`
     - обрамление в `Sequence` с вычислением `from`/`durationInFrames` по таймингу эффекта
   - `src/components/videos/PortraitVideo.tsx`, `src/components/videos/LandscapeVideo.tsx` — прокидывают `staticEffectPath` в `BlendOverlay`.
3) Увеличен рендер-таймаут:
   - `src/short-creator/libraries/Remotion.ts` — `renderTimeout: 120_000`.
4) Тестовые входные данные:
   - `test-overlays-http.json` — содержит сцены с VHS 01/02 и стрелкой. VHS-эффекты перекодированы в совместимый mp4; стрелка также.

## Ожидаемое поведение
- Рендер должен завершаться успешно без зависаний `delayRender` при 3–10 одновременных наложениях.
- Путь к каждому оверлею внутри Remotion должен быть строго через `staticFile('effects/<hash>.<ext>')`.
- Каждое наложение должно появляться в нужном интервале времени (секунды) в рамках сцены, без влияния длительности исходного файла.

## Фактическое поведение
- После всех фиксаций и перекодирований — статус рендера: `failed`. Предыдущие падения сопровождались `delayRender timeout` и/или попытками загрузки через HTTP-путь. Сейчас источник жёстко переведён на `staticFile`, тайминг реализован `Sequence`.

## Репродукция
1. Собрать проект:
   - `cd /root/FantaProjekt && npm run build`
2. Запустить тест рендера (HTTP):
   - `curl -sS -X POST http://localhost:3123/api/short-video -H "Content-Type: application/json" -d @/root/FantaProjekt/test-overlays-http.json`
   - Получить `videoId` из ответа, затем статус:
     - `curl -sS http://localhost:3123/api/short-video/<videoId>/status`
3. Ожидаемо: статус переходит в `ready`. Фактически: `failed`.

## Ограничения и требования
- Не переписывать существующие ядровые функции; добавлять новые файлы/модули и подключать их.
- Поддержка ≥5 (лучше 10) одновременных наложений с разными таймингами.
- Совместимость: видео-оверлеи должны корректно грузиться в Remotion без зависаний по метаданным.
- После исправления — обновить документацию (манифест, статус).

## Архитектурный контекст и ключевые файлы
- Входные типы и структуры:
  - `src/types/shorts.ts` — типы сцены, эффектов, BlendEffect и т.п.
- Оркестрация рендера:
  - `src/short-creator/ShortCreator.ts` — сборка данных, аудио, сабы, эффекты; вызывает Remotion.
  - `src/short-creator/libraries/Remotion.ts` — обёртка над рендером Remotion, настройки таймаутов.
- Рабочие модули эффектов:
  - `src/short-creator/effects/EffectManager.ts`
  - `src/short-creator/effects/OverlayCache.ts`
- Remotion-композиции:
  - `src/remotion/compositions/BlendOverlay.tsx`
  - `src/components/videos/PortraitVideo.tsx`
  - `src/components/videos/LandscapeVideo.tsx`
- Сторонние библиотеки:
  - Remotion, FFmpeg (через наш `src/short-creator/libraries/FFmpeg.ts`)
- Конфигурация Remotion:
  - `remotion.config.ts`

## Последние изменения (по сути)
- Жёсткая фиксация источника наложений на `staticFile(staticEffectPath)`.
- Тайминг наложений через `Sequence`.
- Кэширование и перекодирование оверлеев в `static/effects` по хэшу.
- Увеличенный `renderTimeout`.

## Файлы для изучения (рекомендация по порядку)
1. `src/remotion/compositions/BlendOverlay.tsx`
2. `src/short-creator/effects/OverlayCache.ts`
3. `src/short-creator/effects/EffectManager.ts`
4. `src/components/videos/PortraitVideo.tsx`
5. `src/components/videos/LandscapeVideo.tsx`
6. `src/short-creator/libraries/Remotion.ts`
7. `src/types/shorts.ts`
8. `src/short-creator/ShortCreator.ts`
9. `src/short-creator/libraries/FFmpeg.ts`
10. `test-overlays-http.json`

## Статус документов
- Архитектура: `Документы/АРХИТЕКТУРА.md`
- Статус проекта: `Документы/СТАТУС_ПРОЕКТА.md`
- Этот борт-документ: `Документы/Журнал/ЗАДАЧА_ДЛЯ_РАЗРАБОТЧИКА_ПОЛНЫЙ_КОНТЕКСТ_15OCT2025.md`

## Ожидаемый результат от разработчика
- Воспроизвести падение, локализовать первопричину и исправить.
- Сохранить масштабируемость (5–10 одновременных эффектов), не изменяя существующее ядро — только через новые файлы/модули.
- Обновить `Документы/СТАТУС_ПРОЕКТА.md` и, при необходимости, `Документы/АРХИТЕКТУРА.md` после исправления.
