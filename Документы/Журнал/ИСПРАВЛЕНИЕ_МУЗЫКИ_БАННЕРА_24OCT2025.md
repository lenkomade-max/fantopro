# –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ crime –∏ banner overlay
**–î–∞—Ç–∞:** 24 –æ–∫—Ç—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ú—É–∑—ã–∫–∞ crime_* –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** JSON —Å `"music": "crime_darkhorror"` –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–ª —Å—Ç–∞—Ä—É—é —Ç–∏—Ö—É—é –º—É–∑—ã–∫—É –≤–º–µ—Å—Ç–æ crime —Ç—Ä–µ–∫–æ–≤.

**Root Cause:** –§–∞–π–ª—ã `crime_*.mp3` —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤ `static/music/`, –Ω–æ –ù–ï –±—ã–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ `musicList` –≤ `src/short-creator/music.ts`.

**–ö–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:** Sequential thinking + –ø—Ä–æ–≤–µ—Ä–∫–∞:
- `findMusic()` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç `musicList` –ø–æ `mood === tag`
- –ü–æ–∏—Å–∫ "crime" –≤ music.ts –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ ‚Üí fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –º—É–∑—ã–∫—É

### 2. –ì—Ä–æ–º–∫–æ—Å—Ç—å ultra/very_high —Ç—Ä–µ–±–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù—É–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ultra (90%) –∏ very_high (80%) –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `calculateVolume()` –≤ utils.ts –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `ultra` ‚Üí `[0.9, false]` (90%)
- `very_high` ‚Üí `[0.8, false]` (80%)

### 3. Banner overlay –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ë–∞–Ω–Ω–µ—Ä 1080√ó1920 –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –∫–∞–∫ 360√ó640 –≤ —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞.

**Root Cause:** –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ scale filter, –¥—É–º–∞—è —á—Ç–æ –Ω—É–∂–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä –¥–æ —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ.

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):**
- –ë–∞–Ω–Ω–µ—Ä—ã –∏–∑ Canva –£–ñ–ï –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (1080√ó1920 –¥–ª—è portrait, 1920√ó1080 –¥–ª—è landscape)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º–µ—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –±–∞–Ω–Ω–µ—Ä–∞ —Å greenscreen
- –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –¢–û–õ–¨–ö–û –ø—Ä–∏–º–µ–Ω–∏—Ç—å chromakey –∏ –Ω–∞–ª–æ–∂–∏—Ç—å –±–∞–Ω–Ω–µ—Ä –∫–∞–∫ –µ—Å—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏—é (0, 0)
- –ù–ï –Ω—É–∂–µ–Ω scale!

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã crime —Ç—Ä–µ–∫–∏ –≤ musicList
**–§–∞–π–ª:** `src/short-creator/music.ts` (—Å—Ç—Ä–æ–∫–∏ 195-230)

–ü–æ–ª—É—á–µ–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö 6 —Ç—Ä–µ–∫–æ–≤ —á–µ—Ä–µ–∑ ffprobe:
```typescript
{
  file: "crime_anepic.mp3",
  start: 0,
  end: 134,
  mood: MusicMoodEnum.crime_anepic,
},
{
  file: "crime_darkhorror.mp3",
  start: 0,
  end: 152,
  mood: MusicMoodEnum.crime_darkhorror,
},
{
  file: "crime_disturbance.mp3",
  start: 0,
  end: 137,
  mood: MusicMoodEnum.crime_disturbance,
},
{
  file: "crime_dronesystem.mp3",
  start: 0,
  end: 137,
  mood: MusicMoodEnum.crime_dronesystem,
},
{
  file: "crime_drone_system_stalker.mp3",
  start: 0,
  end: 200,
  mood: MusicMoodEnum.crime_drone_system_stalker,
},
{
  file: "crime_new_report.mp3",
  start: 0,
  end: 212,
  mood: MusicMoodEnum.crime_new_report,
},
```

### 2. –ì—Ä–æ–º–∫–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
**–§–∞–π–ª:** `src/components/utils.ts` (—Å—Ç—Ä–æ–∫–∏ 162-179)

–§—É–Ω–∫—Ü–∏—è `calculateVolume()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- `ultra` ‚Üí 0.9 (90%)
- `very_high` ‚Üí 0.8 (80%)
- `high` ‚Üí 0.7 (70%)

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ PortraitVideo.tsx –∏ LandscapeVideo.tsx —á–µ—Ä–µ–∑:
```typescript
const [musicVolume, musicMuted] = calculateVolume(config.musicVolume);
<Audio volume={() => musicVolume} muted={musicMuted} ... />
```

### 3. –£–±—Ä–∞–Ω scale –∏–∑ banner overlay
**–§–∞–π–ª:** `src/short-creator/effects/EffectManager.ts`

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```typescript
const filterComplex = [
  `[1:v]scale=${videoDimensions.width}:${videoDimensions.height}[banner_scaled]`,
  `[banner_scaled]chromakey=0x00FF00:${similarity}:${blend}[banner]`,
  `[0:v][banner]${overlayFilter}[out]`
].join(';');
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```typescript
// Banner —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ - —Ç–æ–ª—å–∫–æ chromakey + overlay
const filterComplex = [
  `[1:v]chromakey=0x00FF00:${similarity}:${blend}[banner]`,
  `[0:v][banner]${overlayFilter}[out]`
].join(';');
```

**–ü–æ–∑–∏—Ü–∏—è:** Hardcoded (0, 0) –¥–ª—è full-screen overlay (—Å—Ç—Ä–æ–∫–∏ 447-459)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test 1: Banner + Ultra Volume + Crime Music
**–§–∞–π–ª:** `/tmp/test1-banner-ultra.json`
**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –ë–∞–Ω–Ω–µ—Ä: `banner/greenscreenBanner.mp4`
- –ú—É–∑—ã–∫–∞: `crime_darkhorror`
- –ì—Ä–æ–º–∫–æ—Å—Ç—å: `ultra` (90%)
- –≠—Ñ—Ñ–µ–∫—Ç—ã: —Ç–æ–ª—å–∫–æ banner_overlay —Å chromakey

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ test1-banner-ultra-crime_darkhorror.mp4 (3.1 –ú–ë)

### Test 2: Banner + Blend Overlays + Very High Volume
**–§–∞–π–ª:** `/tmp/test2-banner-blend-veryhigh.json`
**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –ë–∞–Ω–Ω–µ—Ä: `banner/greenscreenBanner.mp4`
- –ú—É–∑—ã–∫–∞: `crime_anepic`
- –ì—Ä–æ–º–∫–æ—Å—Ç—å: `very_high` (80%)
- –≠—Ñ—Ñ–µ–∫—Ç—ã:
  - banner_overlay —Å chromakey
  - blend: `vhs_dots_white.mp4` (darken mode, opacity 0.15)
  - blend: `vhs_70s_white.mp4` (hardlight mode, opacity 0.15)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ test2-banner-blends-veryhigh-crime_anepic.mp4 (5.1 –ú–ë)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Docker Build
```bash
npm run build        # TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
rm -rf dist/        # –£–¥–∞–ª–µ–Ω dist/
docker compose build # –£—Å–ø–µ—à–Ω–æ
docker compose up -d # –ó–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3123
```

### API Endpoints
```bash
POST http://localhost:3123/api/short-video
GET http://localhost:3123/api/short-video/:id/status
GET http://localhost:3123/api/short-video/:id
```

### Chromakey –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```typescript
chromakey: {
  color: "0x00FF00",     // –ó–µ–ª–µ–Ω—ã–π
  similarity: 0.4,       // –î–æ–ø—É—Å–∫ –ø–æ —Ü–≤–µ—Ç—É
  blend: 0.1,           // Smoothness
}
```

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. `src/short-creator/music.ts` - –¥–æ–±–∞–≤–ª–µ–Ω—ã 6 crime —Ç—Ä–µ–∫–æ–≤
2. `src/short-creator/effects/EffectManager.ts` - —É–±—Ä–∞–Ω scale –∏–∑ banner overlay
3. `src/components/utils.ts` - –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ calculateVolume()
4. `test1-banner-ultra-crime_darkhorror.mp4` - –≥–æ—Ç–æ–≤ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
5. `test2-banner-blends-veryhigh-crime_anepic.mp4` - –≥–æ—Ç–æ–≤ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞

## –í—ã–≤–æ–¥—ã

‚úÖ **–ú—É–∑—ã–∫–∞ crime —Ä–∞–±–æ—Ç–∞–µ—Ç** - –≤—Å–µ 6 —Ç—Ä–µ–∫–æ–≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—ã–±–æ—Ä–∞
‚úÖ **–ì—Ä–æ–º–∫–æ—Å—Ç—å ultra/very_high —Ä–∞–±–æ—Ç–∞–µ—Ç** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ Audio component
‚úÖ **Banner overlay —Ä–∞–±–æ—Ç–∞–µ—Ç** - –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω –±–µ–∑ scale
‚úÖ **Blend overlays —Ä–∞–±–æ—Ç–∞—é—Ç** - 2 —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

üîú –û—Ç–¥–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö blend —Ä–µ–∂–∏–º–æ–≤ (darken, hardlight) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
