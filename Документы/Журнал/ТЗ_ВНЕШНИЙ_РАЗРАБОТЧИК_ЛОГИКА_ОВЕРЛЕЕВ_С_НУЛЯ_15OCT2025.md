# Техническое задание (ТЗ)
## Разработка с нуля: подсистема наложений (overlay effects) для видеогенератора
Дата: 15 Oct 2025
Версия: 1.0
Адресат: внешний разработчик (нет доступа к нашему коду)

---

## 1. Цель
Создать автономную подсистему наложений (overlay effects) для рендеринга видео, способную:
- поддерживать 5–10 одновременных наложений на сцену;
- управлять таймингами появления/исчезновения каждого наложения;
- поддерживать режимы смешивания (blend modes) и непрозрачность (opacity);
- работать с видео- и изображениями в качестве источников наложений;
- быть легко встраиваемой в любой Node.js + TypeScript проект (интеграция через чёткие интерфейсы).

## 2. Результат работ
Вы предоставляете самостоятельный пакет (папка/репозиторий) на TypeScript со следующей структурой и API. Мы сможем подключить его как зависимость и использовать публичные интерфейсы без переписывания ядра.

### 2.1. Предлагаемая структура пакета
- `src/`
  - `core/`
    - `OverlayEngine.ts` — точка входа рендеринга наложений (агрегация сценовых наложений)
    - `OverlayTrack.ts` — трек наложений для сцены (управление списком эффектов)
    - `OverlayEffect.ts` — сущность эффекта (общие поля), фабрики видео/изображения
  - `io/`
    - `AssetFetcher.ts` — загрузка исходников (HTTP/файлы), проверка MIME/размеров
    - `Transcoder.ts` — при необходимости перекодирование в совместимый формат (h264, yuv420p)
    - `CacheStore.ts` — кэширование активов по хэшу с детерминированными путями
  - `remotion/`
    - `BlendOverlay.tsx` — React‑компонент рендера одного эффекта (для интеграции в Remotion)
    - `MultiOverlayRenderer.tsx` — контейнер рендера нескольких эффектов в сцене
  - `types/`
    - `index.ts` — типы входных данных/результатов
  - `utils/`
    - `hash.ts`, `paths.ts`, `time.ts`
- `README.md` — как собрать, протестировать и интегрировать
- `package.json`, `tsconfig.json`

Примечание: ваша внутренняя реализация может отличаться, но публичные интерфейсы ниже обязательны.

### 2.2. Публичные интерфейсы (TypeScript)
```ts
// types/index.ts
export type BlendMode = 'normal' | 'screen' | 'multiply' | 'overlay' | 'add';

export type OverlayTiming =
  | { kind: 'full' }
  | { kind: 'window'; startSec: number; endSec: number };

export type OverlaySource =
  | { kind: 'image'; src: string }
  | { kind: 'video'; src: string };

export interface OverlayInput {
  id: string;
  source: OverlaySource;
  blendMode: BlendMode;
  opacity: number; // 0..1
  zIndex: number;  // порядок слоя
  timing: OverlayTiming;
}

export interface SceneInput {
  width: number;
  height: number;
  fps: number;
  durationSec: number;
  overlays: OverlayInput[];
}

export interface PreparedAsset {
  id: string;
  kind: 'image' | 'video';
  staticPath: string; // относительный путь для использования в staticFile()
}

export interface PrepareResult {
  assets: PreparedAsset[];
}

// core/OverlayEngine.ts
export interface OverlayEngine {
  prepare(scene: SceneInput): Promise<PrepareResult>; // загрузка/кэш/транскодирование
}
```

### 2.3. Поведение
- Поддержать 5–10 наложений одновременно без деградации UX/рэндера.
- Для каждого эффекта вычислять окно кадров с учётом `fps` и `timing`.
- Хранить подготовленные активы с детерминированными путями (например, `effects/<hash>.<ext>`).
- Для видеороликов обеспечить совместимость (mp4 H.264, yuv420p, faststart), если исходник не совместим — транскодировать.
- В `BlendOverlay.tsx` использовать только статический путь (например, через `staticFile(staticPath)`), без прямых HTTP‑URL.
- Компонент контейнер должен упорядочивать рендер по `zIndex` и включать каждый эффект только в окне его видимости.

## 3. Ограничения
- Не использовать приватные детали нашего проекта. Решение должно быть автономным и встраиваемым.
- Нельзя полагаться на временные пути ОС; использовать кэш с детерминированной структурой.
- Нельзя блокировать рендер: при ошибке загрузки/метаданных — не зависать.

## 4. Критерии приёмки
- Демка из набора сцен (минимум 2 сцены) с 5–10 активными наложениями и разными окнами времени. Рендер не должен падать/виснуть.
- Видео‑акценты (минимум 2 штуки) корректно отображаются; изображения — тоже.
- Пакет собирается `npm run build`; типы корректны; есть README со сценариями запуска/примерами.

## 5. Тестовые данные (в составе пакета)
- Папка `fixtures/` с:
  - несколькими изображениями (png/jpg)
  - несколькими видео (mp4 совместимые; одно несоответствующее для теста перекодирования)
  - JSON‑пример сцен (соответствует `SceneInput`)

## 6. Поставка
- Отдать архив/репозиторий: исходники TS, сборка, README, лицензия.
- Сторонних секретов/ключей быть не должно.

## 7. Сроки и коммуникации
- Предварительный прототип: 2–3 дня.
- Полная версия с тестами и README: 5–7 дней.

---

Любые вопросы, не покрытые ТЗ, трактуются в пользу автономности и предсказуемости поведения (стабильные пути, отсутствие зависаний, корректные типы).