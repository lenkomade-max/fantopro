# üê≥ –û—Ç—á–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ fantaprojekt

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:** `fantaprojekt`  
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**CPU:** 0.00% ‚úÖ (–æ—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)  
**–ü–∞–º—è—Ç—å:** 62.91 MiB / 7.57 GiB (0.8%) ‚úÖ  
**–°–µ—Ç—å:** 1.81 GB –≤—Ö–æ–¥—è—â–∏–π / 332 MB –∏—Å—Ö–æ–¥—è—â–∏–π  
**Uptime:** 32 —á–∞—Å–∞ (healthy)

**–í—ã–≤–æ–¥:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –ø–æ CPU –∏ –ø–∞–º—è—Ç–∏, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∏–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

---

## ‚ö†Ô∏è –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. üêõ –ö–†–ò–¢–ò–ß–ù–û: –ó–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã Chrome Headless –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤:** 74+ –≤ —Å–∏—Å—Ç–µ–º–µ, 72+ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ Remotion –æ—Å—Ç–∞—é—Ç—Å—è –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã `chrome-headless`
- –ü—Ä–æ—Ü–µ—Å—Å—ã –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `<defunct>` (–∑–æ–º–±–∏) –≤ —Å–∏—Å—Ç–µ–º–µ
- –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (–≤–∏–¥–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Ç 12 –Ω–æ—è–±—Ä—è –¥–æ —Å–µ–≥–æ–¥–Ω—è)
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —É—Ç–µ—á–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É

**–ü—Ä–∏–º–µ—Ä –∏–∑ —Å–∏—Å—Ç–µ–º—ã:**
```bash
root       99530  0.0  0.0      0     0 ?        Z    16:45   0:00 [chrome-headless] <defunct>
root       99553  0.0  0.0      0     0 ?        Z    16:45   0:00 [chrome-headless] <defunct>
root       99643  0.5  0.0      0     0 ?        Z    16:45   0:58 [chrome-headless] <defunct>
# ... –∏ –µ—â–µ 71+ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- Remotion –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Puppeteer –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Chrome headless
- –ü–æ—Å–ª–µ `renderMedia()` –ø—Ä–æ—Ü–µ—Å—Å—ã –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `waitpid()` –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –î–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∑–æ–º–±–∏ (zombie processes)

**–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**

1. **`src/short-creator/libraries/Remotion.ts`** (—Å—Ç—Ä–æ–∫–∏ 76-89)
   ```typescript
   await renderMedia({
     codec: "h264",
     composition,
     serveUrl: this.bundled,
     outputLocation,
     inputProps: data,
     onProgress: ({ progress }) => {
       logger.debug(`Rendering ${id} ${Math.floor(progress * 100)}% complete`);
     },
     concurrency: this.config.concurrency,
     offthreadVideoCacheSizeInBytes: this.config.videoCacheSizeInBytes,
     timeoutInMilliseconds: 120000,
   });
   // ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
   ```

2. **`src/short-creator/ShortCreator.ts`** (—Å—Ç—Ä–æ–∫–∏ 434-448)
   ```typescript
   await this.remotion.render(
     {
       music: selectedMusic,
       scenes,
       config: { /* ... */ },
     },
     videoId,
     orientation,
   );
   // ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –Ω–µ—Ç cleanup –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   ```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `renderMedia()` –∏–∑ `@remotion/renderer` –∑–∞–ø—É—Å–∫–∞–µ—Ç Chrome —á–µ—Ä–µ–∑ Puppeteer
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã Chrome –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Node.js) –Ω–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –î–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∑–æ–º–±–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cancelSignal` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Puppeteer –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å cleanup –≤ `finally` –±–ª–æ–∫

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cancelSignal –¥–ª—è cleanup**
```typescript
import { renderMedia, makeCancelSignal } from '@remotion/renderer';

async render(data: z.infer<typeof shortVideoSchema>, id: string, orientation: OrientationEnum) {
  const { cancelSignal } = makeCancelSignal();
  
  try {
    await renderMedia({
      // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      cancelSignal,
    });
  } finally {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –¥–ª—è cleanup –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    cancelSignal.cancel();
  }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–∏—Ç—å timeout –∏ cleanup**
```typescript
import { renderMedia } from '@remotion/renderer';
import { kill } from 'process';

async render(data: z.infer<typeof shortVideoSchema>, id: string, orientation: OrientationEnum) {
  const renderPromise = renderMedia({
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  });

  // Timeout –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => {
      reject(new Error('Render timeout'));
    }, 120000);
  });

  try {
    await Promise.race([renderPromise, timeoutPromise]);
  } catch (error) {
    // Cleanup –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    this.cleanupZombieProcesses();
    throw error;
  }
}

private cleanupZombieProcesses() {
  // –ù–∞–π—Ç–∏ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã chrome-headless
  // –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ child_process –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ kill
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Puppeteer browser.close() –Ω–∞–ø—Ä—è–º—É—é**
```typescript
// –í Remotion.ts –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ browser instance
// –ù–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ Remotion —Å–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
ps aux | grep "chrome-headless.*defunct" | wc -l

# –ó–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker exec fantaprojekt ps aux | grep "chrome.*defunct" | wc -l

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
ps aux | awk '$8 ~ /^Z/ { print $0 }' | grep chrome
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–û - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã, –º–æ–≥—É—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É

---

### 2. PayloadTooLargeError - –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫:** 8 –≤ –ª–æ–≥–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –ó–∞–ø—Ä–æ—Å—ã —Å –±–æ–ª—å—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ JSON) –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- –û—à–∏–±–∫–∞: `PayloadTooLargeError: request entity too large`
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ body-parser middleware

**–§–∞–π–ª—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ª–∏–º–∏—Ç–∞:**

1. **`src/server/server.ts`** (—Å—Ç—Ä–æ–∫–∏ 34-35)
   ```typescript
   // Increase payload size limit for large photo uploads
   this.app.use(express.json({ limit: '150mb' }));
   this.app.use(express.urlencoded({ limit: '150mb', extended: true }));
   ```

2. **`src/server/routers/rest.ts`** (—Å—Ç—Ä–æ–∫–∏ 34-35)
   ```typescript
   // Increase payload limit to support base64 photo uploads in JSON
   this.router.use(express.json({ limit: "150mb" }));
   this.router.use(express.urlencoded({ limit: "150mb", extended: true }));
   ```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ–∏–º–∏—Ç 150mb –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ base64
- Base64 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ~33%
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –¥–æ 300-500mb
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å multipart/form-data –≤–º–µ—Å—Ç–æ JSON –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ò–ª–∏ —Å–∂–∏–º–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
docker logs fantaprojekt 2>&1 | grep -c "PayloadTooLargeError"
```

---

### 3. –î—É–±–ª–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤–∏–¥–µ–æ

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:** 8 –≤ –ª–æ–≥–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è 2 –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤–∏–¥–µ–æ
- –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ–± —ç—Ç–æ–º
- –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∑–∞–≤–∏—Å–∞–Ω–∏—é

**–ü—Ä–∏–º–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏–∑ –ª–æ–≥–æ–≤:**
```
‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞!

–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∑–∞–≤–∏—Å–∞–Ω–∏—é.

–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:
‚Ä¢ cmhxrlrf: Applying effect 1/1... (95%)
‚Ä¢ cmhxrp3l: Initializing (0%)
```

**–§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**

1. **`src/short-creator/ShortCreator.ts`**

   **–°—Ç—Ä–æ–∫–∞ 94:** `// todo add mutex lock` - TODO –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
   ```typescript
   public addToQueue(sceneInput: SceneInput[], config: RenderConfig): string {
     // todo add mutex lock  ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race condition
     const id = cuid();
     this.queue.push({
       sceneInput,
       config,
       id,
     });
     // ...
   }
   ```

   **–°—Ç—Ä–æ–∫–∞ 121:** `// todo add a semaphore` - TODO –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
   ```typescript
   private async processQueue(): Promise<void> {
     // todo add a semaphore  ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
     if (this.queue.length === 0) {
       return;
     }
     const { sceneInput, config, id } = this.queue[0];
     // ...
   }
   ```

   **–ü—Ä–æ–±–ª–µ–º–∞:**
   - –ú–µ—Ç–æ–¥ `processQueue()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (—Å—Ç—Ä–æ–∫–∞ 165)
   - –ï—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±–∞ –º–æ–≥—É—Ç –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –æ—á–µ—Ä–µ–¥—å

2. **`src/monitoring/ProcessMonitor.ts`**

   **–°—Ç—Ä–æ–∫–∏ 172-187:** –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
   ```typescript
   private async sendDualProcessAlert(processes: ProcessInfo[]): Promise<void> {
     // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   }
   ```

   **–ü—Ä–æ–±–ª–µ–º–∞:**
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç, –Ω–æ –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
   - –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å semaphore –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- –î–æ–±–∞–≤–∏—Ç—å mutex lock –¥–ª—è –º–µ—Ç–æ–¥–∞ `addToQueue()`
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ `processQueue()`

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```typescript
import { Semaphore } from 'async-mutex';

export class ShortCreator {
  private renderSemaphore = new Semaphore(1); // –¢–æ–ª—å–∫–æ 1 –ø—Ä–æ—Ü–µ—Å—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  private queueLock = new Mutex(); // –ó–∞—â–∏—Ç–∞ –æ—á–µ—Ä–µ–¥–∏

  public async addToQueue(sceneInput: SceneInput[], config: RenderConfig): Promise<string> {
    await this.queueLock.acquire();
    try {
      const id = cuid();
      this.queue.push({ sceneInput, config, id });
      // ...
    } finally {
      this.queueLock.release();
    }
  }

  private async processQueue(): Promise<void> {
    if (this.queue.length === 0) {
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –æ—á–µ—Ä–µ–¥—å
    if (this.renderSemaphore.isLocked()) {
      return; // –£–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    }

    await this.renderSemaphore.acquire();
    try {
      const { sceneInput, config, id } = this.queue[0];
      // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    } finally {
      this.renderSemaphore.release();
      this.queue.shift();
      // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
      if (this.queue.length > 0) {
        this.processQueue();
      }
    }
  }
}
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
docker logs fantaprojekt 2>&1 | grep "dual_processes"
```

---

## üîç –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—á–µ—Ä–µ–¥–∏ –æ—Ç race conditions

**–§–∞–π–ª:** `src/short-creator/ShortCreator.ts`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç mutex/semaphore –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—á–µ—Ä–µ–¥–∏
- –ú–µ—Ç–æ–¥ `processQueue()` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –º–æ–≥—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

**–°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:**
- –°—Ç—Ä–æ–∫–∞ 29: `private queue: QueueItem[] = []` - –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –∑–∞—â–∏—Ç—ã
- –°—Ç—Ä–æ–∫–∞ 94: `// todo add mutex lock` - TODO –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
- –°—Ç—Ä–æ–∫–∞ 121: `// todo add a semaphore` - TODO –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
- –°—Ç—Ä–æ–∫–∞ 165: `this.processQueue()` - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏

---

### 2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞

**–§–∞–π–ª—ã:**
- `src/server/server.ts` (—Å—Ç—Ä–æ–∫–∏ 34-35)
- `src/server/routers/rest.ts` (—Å—Ç—Ä–æ–∫–∏ 34-35)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ–∏–º–∏—Ç 150mb –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è:
  - –ù–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ–ª—å—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ base64
  - –í–∏–¥–µ–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–µ–≤—å—é
  - –°–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 300-500mb
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å streaming upload –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –ò–ª–∏ —Å–∂–∏–º–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

---

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç

**–§–∞–π–ª:** `src/monitoring/ProcessMonitor.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
- –ù–æ –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –∑–∞–ø—É—Å–∫
- –¢–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

**–°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:**
- –°—Ç—Ä–æ–∫–∏ 172-187: `sendDualProcessAlert()` - —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å ShortCreator –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `addToQueue()` –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

---

### 4. –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –±–µ–∑ –∑–∞—â–∏—Ç—ã

**–§–∞–π–ª:** `src/short-creator/ShortCreator.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ—Ç–æ–¥ `processQueue()` –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∞–º —Å–µ–±—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (—Å—Ç—Ä–æ–∫–∞ 165)
- –ï—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–¥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±–∞ –º–æ–≥—É—Ç –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ –æ—á–µ—Ä–µ–¥—å

**–°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:**
- –°—Ç—Ä–æ–∫–∞ 120-167: `processQueue()` - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –°—Ç—Ä–æ–∫–∞ 165: `this.processQueue()` - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `isProcessing` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å semaphore –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

---

## üìÅ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

1. **`src/short-creator/ShortCreator.ts`**
   - –°—Ç—Ä–æ–∫–∞ 29: –û—á–µ—Ä–µ–¥—å –±–µ–∑ –∑–∞—â–∏—Ç—ã
   - –°—Ç—Ä–æ–∫–∞ 94: TODO - –¥–æ–±–∞–≤–∏—Ç—å mutex lock
   - –°—Ç—Ä–æ–∫–∞ 121: TODO - –¥–æ–±–∞–≤–∏—Ç—å semaphore
   - –°—Ç—Ä–æ–∫–∞ 120-167: –ú–µ—Ç–æ–¥ `processQueue()` –±–µ–∑ –∑–∞—â–∏—Ç—ã –æ—Ç race conditions
   - –°—Ç—Ä–æ–∫–∞ 165: –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

2. **`src/server/server.ts`**
   - –°—Ç—Ä–æ–∫–∏ 34-35: –õ–∏–º–∏—Ç body-parser 150mb (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

3. **`src/server/routers/rest.ts`**
   - –°—Ç—Ä–æ–∫–∏ 34-35: –õ–∏–º–∏—Ç body-parser 150mb (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

### –ü—Ä–æ–±–ª–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è)

4. **`src/monitoring/ProcessMonitor.ts`**
   - –°—Ç—Ä–æ–∫–∏ 172-187: –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
   - –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ShortCreator –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Chrome (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `src/short-creator/libraries/Remotion.ts`

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å cleanup –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cancelSignal` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å cleanup

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```typescript
import { renderMedia, makeCancelSignal } from '@remotion/renderer';

async render(
  data: z.infer<typeof shortVideoSchema>,
  id: string,
  orientation: OrientationEnum,
) {
  const { cancelSignal, cancel } = makeCancelSignal();
  let renderCompleted = false;

  try {
    const { component } = getOrientationConfig(orientation);

    const composition = await selectComposition({
      serveUrl: this.bundled,
      id: component,
      inputProps: data,
    });

    logger.debug({ component, videoID: id }, "Rendering video with Remotion");

    const outputLocation = path.join(this.config.videosDirPath, `${id}.mp4`);

    await renderMedia({
      codec: "h264",
      composition,
      serveUrl: this.bundled,
      outputLocation,
      inputProps: data,
      cancelSignal, // –î–æ–±–∞–≤–∏—Ç—å cancelSignal
      onProgress: ({ progress }) => {
        logger.debug(`Rendering ${id} ${Math.floor(progress * 100)}% complete`);
      },
      concurrency: this.config.concurrency,
      offthreadVideoCacheSizeInBytes: this.config.videoCacheSizeInBytes,
      timeoutInMilliseconds: 120000,
    });

    renderCompleted = true;

    logger.debug(
      {
        outputLocation,
        component,
        videoID: id,
      },
      "Video rendered with Remotion",
    );
  } catch (error) {
    logger.error({ error, videoID: id }, "Error during Remotion render");
    throw error;
  } finally {
    // Cleanup: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    if (!renderCompleted) {
      try {
        cancel();
        logger.debug({ videoID: id }, "Cancelled render signal for cleanup");
      } catch (cleanupError) {
        logger.warn({ cleanupError }, "Error during render cleanup");
      }
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π cleanup –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –¥–ª—è cleanup
  }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π cleanup –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ ProcessMonitor:
```typescript
// –í ProcessMonitor.ts
private async cleanupZombieProcesses() {
  try {
    // –ù–∞–π—Ç–∏ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã chrome-headless
    const { exec } = require('child_process');
    exec('pkill -9 chrome-headless || true', (error) => {
      if (error) {
        logger.warn({ error }, 'Failed to cleanup zombie processes');
      }
    });
  } catch (error) {
    logger.warn({ error }, 'Error in zombie cleanup');
  }
}
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ó–∞—â–∏—Ç–∞ –æ—á–µ—Ä–µ–¥–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `src/short-creator/ShortCreator.ts`

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç –¥–ª—è semaphore:
   ```bash
   npm install async-mutex
   ```

2. –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:
   ```typescript
   import { Semaphore, Mutex } from 'async-mutex';
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –∫–ª–∞—Å—Å ShortCreator:
   ```typescript
   export class ShortCreator {
     private renderSemaphore = new Semaphore(1); // –¢–æ–ª—å–∫–æ 1 –ø—Ä–æ—Ü–µ—Å—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
     private queueLock = new Mutex(); // –ó–∞—â–∏—Ç–∞ –æ—á–µ—Ä–µ–¥–∏
     private isProcessing = false; // –§–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
     // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
   }
   ```

4. –ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `addToQueue()`:
   ```typescript
   public async addToQueue(sceneInput: SceneInput[], config: RenderConfig): Promise<string> {
     await this.queueLock.acquire();
     try {
       const id = cuid();
       this.queue.push({ sceneInput, config, id });
       
       if (this.processMonitor) {
         this.processMonitor.registerProcess(id);
       }
       
       // –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
       if (!this.isProcessing && this.queue.length === 1) {
         this.processQueue();
       }
       
       return id;
     } finally {
       this.queueLock.release();
     }
   }
   ```

5. –ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `processQueue()`:
   ```typescript
   private async processQueue(): Promise<void> {
     // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ
     if (this.isProcessing) {
       return;
     }

     if (this.queue.length === 0) {
       return;
     }

     // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
     this.isProcessing = true;

     try {
       await this.renderSemaphore.acquire();
       
       try {
         const { sceneInput, config, id } = this.queue[0];
         // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
       } finally {
         this.renderSemaphore.release();
       }
     } finally {
       this.queue.shift();
       this.isProcessing = false;
       
       // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
       if (this.queue.length > 0) {
         this.processQueue();
       }
     }
   }
   ```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ body-parser

**–§–∞–π–ª—ã:**
- `src/server/server.ts` (—Å—Ç—Ä–æ–∫–∏ 34-35)
- `src/server/routers/rest.ts` (—Å—Ç—Ä–æ–∫–∏ 34-35)

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
–ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç —Å `150mb` –Ω–∞ `300mb`:

```typescript
// –ë—ã–ª–æ:
this.app.use(express.json({ limit: '150mb' }));
this.app.use(express.urlencoded({ limit: '150mb', extended: true }));

// –°—Ç–∞–ª–æ:
this.app.use(express.json({ limit: '300mb' }));
this.app.use(express.urlencoded({ limit: '300mb', extended: true }));
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ –≤ –ø–∞–º—è—Ç—å.

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –£–ª—É—á—à–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–§–∞–π–ª:** `src/monitoring/ProcessMonitor.ts`

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –º–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å:
   ```typescript
   canStartNewProcess(): boolean {
     const activeCount = Array.from(this.processes.values())
       .filter(p => p.status === 'processing').length;
     return activeCount < 1; // –ú–∞–∫—Å–∏–º—É–º 1 –ø—Ä–æ—Ü–µ—Å—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   }
   ```

2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å ShortCreator –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
   ```typescript
   // –í ShortCreator.addToQueue():
   if (this.processMonitor && !this.processMonitor.canStartNewProcess()) {
     throw new Error('Another rendering process is already running');
   }
   ```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –∏–∑ –ª–æ–≥–æ–≤

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
docker logs fantaprojekt 2>&1 | tail -n 1000
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **–ó–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã Chrome:** 74+ –≤ —Å–∏—Å—Ç–µ–º–µ, 72+ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ üî¥
- **PayloadTooLargeError:** 8 –æ—à–∏–±–æ–∫
- **–î—É–±–ª–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:** 8 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- **–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1000 —Å—Ç—Ä–æ–∫–∞—Ö:** 64
- **–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É—Ç–µ—á–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–±–ª–æ–∫–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É):

1. üêõ **–ó–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å—ã Chrome Headless** - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
   - –§–∞–π–ª: `src/short-creator/libraries/Remotion.ts`
   - –°—Ç—Ä–æ–∫–∏: 76-89
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 74+ –∑–æ–º–±–∏-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–û

2. ‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—á–µ—Ä–µ–¥–∏** - –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   - –§–∞–π–ª: `src/short-creator/ShortCreator.ts`
   - –°—Ç—Ä–æ–∫–∏: 29, 94, 121, 120-167

3. ‚úÖ **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –ª–∏–º–∏—Ç body-parser** - –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
   - –§–∞–π–ª—ã: `src/server/server.ts`, `src/server/routers/rest.ts`
   - –°—Ç—Ä–æ–∫–∏: 34-35 –≤ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö

### –í–∞–∂–Ω—ã–µ (–≤–ª–∏—è—é—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å):

4. ‚ö†Ô∏è **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç** - –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã
   - –§–∞–π–ª: `src/monitoring/ProcessMonitor.ts`
   - –°—Ç—Ä–æ–∫–∏: 172-187

5. ‚ö†Ô∏è **–†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ –∑–∞—â–∏—Ç—ã** - –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ race conditions
   - –§–∞–π–ª: `src/short-creator/ShortCreator.ts`
   - –°—Ç—Ä–æ–∫–∞: 165

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫:
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ PayloadTooLargeError
docker logs fantaprojekt 2>&1 | grep -c "PayloadTooLargeError"

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
docker logs fantaprojekt 2>&1 | grep -c "dual_processes"

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
docker logs fantaprojekt 2>&1 | grep -E "error|Error|ERROR" | tail -n 20
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫:
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker stats fantaprojekt --no-stream

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep fantaprojekt
```

### –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤:
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1000 —Å—Ç—Ä–æ–∫–∞—Ö
docker logs fantaprojekt 2>&1 | tail -n 1000 | grep -E "GET|POST" | wc -l

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã
docker logs fantaprojekt 2>&1 | tail -n 100 | grep -E "GET|POST"
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**Docker:**
- `docker-compose.yml` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- `Dockerfile` - –æ–±—Ä–∞–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
- `src/config.ts` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `package.json` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ async-mutex)

**–õ–æ–≥–∏:**
- `docker logs fantaprojekt` - –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

---

**–§–∞–π–ª —Å–æ–∑–¥–∞–Ω:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–î–ª—è:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞  
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

