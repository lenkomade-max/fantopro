# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: АНАЛИЗ И ИСПРАВЛЕНИЕ СИСТЕМЫ OVERLAY ЭФФЕКТОВ

## ПРОБЛЕМА

Система overlay эффектов в проекте FantaProjekt работает технически корректно, но результат не соответствует ожиданиям пользователя. Эффекты наложения работают не так, как в профессиональных видеоредакторах (например, CapCut).

### Текущее состояние:
- ✅ Эффекты загружаются и отображаются
- ✅ Режимы наложения применяются
- ❌ **Результат выглядит неправильно** - основное видео становится тусклым, эффекты "съедают" основное видео

### Ожидаемое поведение:
- Основное видео должно оставаться полностью видимым и ярким
- Overlay эффекты должны накладываться как **тонкие эффекты**, а не затемнять основное видео
- Результат должен быть аналогичен CapCut: эффект виден, но не мешает восприятию основного контента

## ТЕХНИЧЕСКАЯ АРХИТЕКТУРА

### Структура файлов эффектов:
```
/root/FantaProjekt/static/effects/
├── VHS_01_small.mp4          # VHS эффект 1 (4.7MB)
├── VHS_02_small.mp4          # VHS эффект 2 (3.4MB)  
└── overlay_arrow.mp4         # Стрелка эффект
```

### Ключевые компоненты системы:

#### 1. EffectManager.ts
**Путь:** `/root/FantaProjekt/src/short-creator/effects/EffectManager.ts`
- Обрабатывает эффекты и их пути
- Проверяет локальные пути к файлам
- Запрещает HTTP/HTTPS URLs и .mov файлы

#### 2. BlendOverlay.tsx  
**Путь:** `/root/FantaProjekt/src/remotion/compositions/BlendOverlay.tsx`
- Основной компонент рендеринга overlay эффектов
- Использует `mixBlendMode` CSS свойство
- Применяет opacity и режимы наложения

#### 3. PortraitVideo.tsx / LandscapeVideo.tsx
**Пути:** 
- `/root/FantaProjekt/src/components/videos/PortraitVideo.tsx`
- `/root/FantaProjekt/src/components/videos/LandscapeVideo.tsx`
- Интегрируют BlendOverlay в основной рендеринг

### Режимы наложения:
Поддерживаются все стандартные CSS blend modes:
- `screen`, `add`, `lighten`, `normal`, `difference`, `exclusion`
- `color-dodge`, `linear-dodge`, `overlay`, `soft-light`, `hard-light`
- `multiply`, `color-burn`, `darken`, `hue`, `saturation`, `color`
- `luminosity`, `linear-burn`, `vivid-light`, `pin-light`, `hard-mix`

## ПУТИ К ФАЙЛАМ ЭФФЕКТОВ

### Локальные пути:
```typescript
// В EffectManager.ts
staticEffectPath: "effects/VHS_01_small.mp4"

// В BlendOverlay.tsx  
const src = staticEffectPath ? staticFile(staticEffectPath) : overlayPath;
```

### Remotion staticFile():
```typescript
import { staticFile } from "remotion";
// staticFile("effects/VHS_01_small.mp4") -> "/static/effects/VHS_01_small.mp4"
```

## ТЕСТОВЫЕ КОНФИГУРАЦИИ

### Пример тестового файла:
```json
{
  "scenes": [{
    "effects": [
      {
        "type": "blend",
        "staticEffectPath": "effects/VHS_01_small.mp4",
        "blendMode": "screen",
        "opacity": 1.0,
        "duration": "full",
        "isVideo": true
      }
    ]
  }]
}
```

### Тестовые видео:
- `test-fixed-blend-modes.mp4` - с исправленными режимами наложения
- `test-three-effects-linear-burn.mp4` - с тремя эффектами
- `test-three-effects-overlay.mp4` - с режимом overlay

## ЗАДАЧИ ДЛЯ РАЗРАБОТЧИКА

### 1. АНАЛИЗ ТЕКУЩЕЙ СИСТЕМЫ
- [ ] Изучить как работает `mixBlendMode` в Remotion
- [ ] Проанализировать почему эффекты затемняют основное видео
- [ ] Сравнить с поведением в CapCut/других редакторах

### 2. ДИАГНОСТИКА ПРОБЛЕМЫ
- [ ] Определить корневую причину неправильного смешивания
- [ ] Проверить поддержку CSS blend modes в Remotion
- [ ] Исследовать альтернативные подходы к смешиванию слоев

### 3. ВОЗМОЖНЫЕ РЕШЕНИЯ
- [ ] **Вариант A:** Исправить текущую CSS-based систему
- [ ] **Вариант B:** Реализовать Canvas API для точного контроля смешивания  
- [ ] **Вариант C:** Использовать WebGL для профессионального смешивания
- [ ] **Вариант D:** Предобработка эффектов (удаление черного фона)

### 4. ТРЕБОВАНИЯ К РЕШЕНИЮ
- ✅ Сохранить текущую архитектуру (минимальные изменения)
- ✅ Поддержать все режимы наложения
- ✅ Обеспечить производительность рендеринга
- ✅ Результат должен соответствовать CapCut

## КРИТЕРИИ УСПЕХА

**Тест:** Создать видео с overlay эффектом на черном фоне с цветными элементами
- **Ожидаемый результат:** Основное видео яркое и четкое, эффект виден как тонкое наложение
- **Текущий результат:** Основное видео тусклое, эффект "съедает" контент

## ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ

### Технический стек:
- **Remotion** 4.0.358 (видео рендеринг)
- **React** (компоненты)
- **TypeScript** (типизация)
- **CSS mix-blend-mode** (текущее смешивание)

### Ограничения:
- Только локальные MP4 файлы (без HTTP URLs)
- Запрет .mov файлов
- Поддержка больших видео файлов (до 50MB)

### Контакты:
При возникновении вопросов обращаться к основному разработчику проекта.

---
**Дата создания:** $(date)  
**Статус:** Требует анализа и исправления  
**Приоритет:** Высокий
